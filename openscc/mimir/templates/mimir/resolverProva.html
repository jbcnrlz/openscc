{% extends "mimirBase.html" %}
{% load feedback_tags %}

{% block mainContent %}
<div class="container py-4">
    <!-- Cabeçalho da Prova -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">{{ prova_aluno.prova.titulo }}</h4>
                <small>{{ prova_aluno.prova.descricao }}</small>
            </div>
            <div class="text-end">
                <div id="timer" class="h5 mb-0">02:00:00</div>
                <small>Tempo restante</small>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <p class="mb-2"><strong>Assunto:</strong> {{ prova_aluno.prova.assunto.nome }}</p>
                    <p class="mb-0"><strong>Status:</strong> 
                        <span class="badge bg-warning text-dark">Em Andamento</span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finalizarModal">
                        <i class="fas fa-flag-checkered me-1"></i>Finalizar Prova
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo de Status -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <h4 class="text-primary">{{ perguntas|length }}</h4>
                    <small class="text-muted">Total de Questões</small>
                </div>
                <div class="col-md-4">
                    <h4 class="text-success" id="contador-respostas-header">0</h4>
                    <small class="text-muted">Respondidas</small>
                </div>
                <div class="col-md-4">
                    <h4 class="text-warning" id="contador-pendentes-header">{{ perguntas|length }}</h4>
                    <small class="text-muted">Pendentes</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário da Prova - Todas as questões visíveis -->
    <form id="provaForm">
        {% csrf_token %}
        
        {% for pergunta in perguntas %}
        {% with resposta_existente=respostas_existentes|get_item:pergunta.id %}
        <div class="card shadow-sm mb-4 questao-item" id="questao-{{ forloop.counter }}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Questão {{ forloop.counter }}</h5>
                <span class="badge" id="status-badge-{{ pergunta.id }}">
                    {% if resposta_existente and resposta_existente.resposta_texto %}
                    <i class="fas fa-check text-success"></i> Respondida
                    {% elif resposta_existente and resposta_existente.arquivo_resposta %}
                    <i class="fas fa-check text-success"></i> Respondida
                    {% else %}
                    <i class="fas fa-clock text-warning"></i> Pendente
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                <!-- Enunciado -->
                <div class="mb-4">
                    <div class="enunciado-questao">
                        {{ pergunta.pergunta|linebreaks }}
                    </div>
                    
                    <!-- Imagens da questão -->
                    {% for imagem in pergunta.imagens.all %}
                    <div class="text-center my-3">
                        <img src="{{ imagem.imagem.url }}" alt="Imagem da questão {{ forloop.parentloop.counter }}" 
                             class="img-fluid rounded shadow-sm" style="max-height: 300px;">
                    </div>
                    {% endfor %}
                </div>

                <!-- Área de resposta -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Sua resposta:</label>
                    
                    {% if pergunta.tipoDePergunta.descricao|lower == "múltipla escolha" or pergunta.tipoDePergunta.descricao|lower == "multipla escolha" or pergunta.tipoDePergunta.descricao|lower == "multiple choice" %}
                        <!-- Renderização para múltipla escolha -->
                        <div class="alternativas-container" id="alternativas-{{ pergunta.id }}">
                            {% with alternativas=pergunta.pergunta|extrair_alternativas %}
                            {% for letra, texto in alternativas.items %}
                            <div class="form-check mb-2">
                                <input class="form-check-input alternativa-radio" 
                                       type="radio" 
                                       name="resposta-{{ pergunta.id }}" 
                                       id="alt-{{ pergunta.id }}-{{ letra }}"
                                       value="{{ letra }}"
                                       data-pergunta-id="{{ pergunta.id }}"
                                       {% if resposta_existente and resposta_existente.resposta_texto == letra %}checked{% endif %}>
                                <label class="form-check-label" for="alt-{{ pergunta.id }}-{{ letra }}">
                                    <strong>{{ letra }})</strong> {{ texto }}
                                </label>
                            </div>
                            {% endfor %}
                            {% endwith %}
                        </div>
                    
                    {% elif pergunta.aceita_upload_resposta %}
                        <!-- Renderização para perguntas que aceitam upload de arquivo -->
                        <div class="upload-resposta-container" id="upload-container-{{ pergunta.id }}">
                            
                            <!-- Arquivo atual (se existir) -->
                            {% if resposta_existente and resposta_existente.arquivo_resposta %}
                            <div class="mb-3">
                                <div class="alert alert-success">
                                    <i class="fas fa-file me-2"></i>
                                    <strong>Arquivo atual:</strong> 
                                    <a href="{{ resposta_existente.arquivo_resposta.url }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-download me-1"></i>Baixar
                                    </a>
                                    <span class="ms-2 text-muted">{{ resposta_existente.arquivo_resposta.name }}</span>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger ms-2" 
                                            onclick="removerArquivoResposta({{ pergunta.id }})">
                                        <i class="fas fa-trash me-1"></i>Remover
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Área de upload -->
                            <div class="border rounded p-3 bg-light">
                                <div class="mb-3">
                                    <label for="arquivo-{{ pergunta.id }}" class="form-label">
                                        <strong>Enviar arquivo de resposta:</strong>
                                    </label>
                                    <input type="file" 
                                           class="form-control arquivo-resposta" 
                                           id="arquivo-{{ pergunta.id }}" 
                                           name="arquivo-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}"
                                           accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt">
                                    <div class="form-text">
                                        Formatos aceitos: PDF, Word, imagens (JPG, PNG), texto. Máx: 10MB.
                                    </div>
                                </div>
                                
                                <!-- Preview do arquivo -->
                                <div id="preview-arquivo-{{ pergunta.id }}" class="mt-3" style="display: none;">
                                    <h6>Preview do arquivo:</h6>
                                    <div id="info-arquivo-{{ pergunta.id }}" class="alert alert-secondary"></div>
                                </div>
                            </div>
                            
                            <!-- Alternativa: resposta em texto (opcional) -->
                            <div class="mt-3">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-secondary" 
                                        onclick="toggleRespostaTexto({{ pergunta.id }})">
                                    <i class="fas fa-edit me-1"></i>Prefiro digitar a resposta
                                </button>
                            </div>
                            
                            <!-- Campo de texto (inicialmente oculto) -->
                            <div id="textarea-container-{{ pergunta.id }}" class="mt-3" style="display: none;">
                                <textarea class="form-control resposta-texto" 
                                          id="resposta-{{ pergunta.id }}" 
                                          name="resposta-{{ pergunta.id }}"
                                          rows="4" 
                                          placeholder="Digite sua resposta aqui..."
                                          data-pergunta-id="{{ pergunta.id }}"></textarea>
                                <div class="mt-2">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary" 
                                            onclick="toggleRespostaTexto({{ pergunta.id }})">
                                        <i class="fas fa-upload me-1"></i>Voltar para upload de arquivo
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                    {% else %}
                        <!-- Renderização padrão (textarea) para outras perguntas -->
                        <textarea class="form-control resposta-texto" 
                                  id="resposta-{{ pergunta.id }}" 
                                  name="resposta-{{ pergunta.id }}"
                                  rows="6" 
                                  placeholder="Digite sua resposta aqui..."
                                  data-pergunta-id="{{ pergunta.id }}">{% if resposta_existente %}{{ resposta_existente.resposta_texto }}{% endif %}</textarea>
                    {% endif %}
                </div>

                <!-- Status de salvamento -->
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="status-{{ pergunta.id }}">
                        {% if resposta_existente and resposta_existente.resposta_texto %}
                        <i class="fas fa-check text-success"></i> Resposta salva - Última atualização: {{ resposta_existente.atualizado_em|date:"H:i" }}
                        {% elif resposta_existente and resposta_existente.arquivo_resposta %}
                        <i class="fas fa-check text-success"></i> Arquivo salvo - Última atualização: {{ resposta_existente.atualizado_em|date:"H:i" }}
                        {% else %}
                        <i class="fas fa-sync text-secondary"></i> Não salvo
                        {% endif %}
                    </small>
                    <small class="text-muted">Questão {{ forloop.counter }} de {{ perguntas|length }}</small>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}

        <!-- Botão de Finalizar fixo no final -->
        <div class="sticky-bottom py-3 bg-light border-top">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted" id="contador-final">
                            <strong id="contador-respostas-final">0</strong> de {{ perguntas|length }} questões respondidas
                        </span>
                    </div>
                    <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#finalizarModal">
                        <i class="fas fa-flag-checkered me-2"></i>Finalizar Prova
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Finalização -->
<div class="modal fade" id="finalizarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Finalizar Prova</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja finalizar a prova?</p>
                <p class="text-muted small">Após finalizar, você não poderá mais alterar suas respostas.</p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Resumo:</strong>
                    <div class="mt-2">
                        <div><strong>Respondidas:</strong> <span id="contador-respostas-modal">0</span> de {{ perguntas|length }} questões</div>
                        <div><strong>Pendentes:</strong> <span id="contador-pendentes-modal">{{ perguntas|length }}</span> questões</div>
                    </div>
                </div>

                <!-- Lista de questões pendentes -->
                <div class="alert alert-warning" id="alert-pendentes" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção!</strong> Você possui questões pendentes:
                    <div id="lista-pendentes" class="mt-2 small"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuar Prova</button>
                <button type="button" class="btn btn-success" id="btn-finalizar-confirmado">
                    <i class="fas fa-flag-checkered me-1"></i>Finalizar Mesmo Assim
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== DECLARAÇÃO DE VARIÁVEIS GLOBAIS =====
let respostasSalvas = new Set();
let tempoRestante = {{ aplicacao.tempo_limite.total_seconds|default:7200|stringformat:"d" }};

// ===== DECLARAÇÃO DE TODAS AS FUNÇÕES PRIMEIRO =====

// Timer
function iniciarTimer() {
    const timerElement = document.getElementById('timer');
    
    const timerInterval = setInterval(() => {
        tempoRestante--;
        
        if (tempoRestante <= 0) {
            clearInterval(timerInterval);
            finalizarProvaAutomaticamente();
            return;
        }
        
        const horas = Math.floor(tempoRestante / 3600);
        const minutos = Math.floor((tempoRestante % 3600) / 60);
        const segundos = tempoRestante % 60;
        
        timerElement.textContent = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        
        // Alerta quando faltar 5 minutos
        if (tempoRestante === 300) {
            mostrarAlertaTempo('5 minutos');
        }
        // Alerta quando faltar 1 minuto
        else if (tempoRestante === 60) {
            mostrarAlertaTempo('1 minuto');
        }
    }, 1000);
}

function mostrarAlertaTempo(tempo) {
    const alerta = document.createElement('div');
    alerta.className = 'alert alert-warning alert-dismissible fade show';
    alerta.innerHTML = `
        <i class="fas fa-clock me-2"></i>
        <strong>Atenção!</strong> Faltam ${tempo} para o término da prova.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container.py-4').insertBefore(alerta, document.querySelector('.card'));
}

function finalizarProvaAutomaticamente() {
    // Salvar todas as respostas antes de finalizar
    salvarTodasRespostas().then(() => {
        alert('Tempo esgotado! A prova será finalizada automaticamente.');
        window.location.href = "{% url 'mimir:finalizarProva' prova_aluno.id %}";
    });
}

// ===== FUNÇÕES PARA UPLOAD DE ARQUIVO =====

// Alternar entre upload e texto
function toggleRespostaTexto(perguntaId) {
    const uploadContainer = document.getElementById(`upload-container-${perguntaId}`);
    const textareaContainer = document.getElementById(`textarea-container-${perguntaId}`);
    
    if (textareaContainer.style.display === 'none') {
        // Mostrar textarea, ocultar upload
        textareaContainer.style.display = 'block';
        uploadContainer.querySelector('.border').style.display = 'none';
        uploadContainer.querySelector('.mt-3 button').style.display = 'none';
    } else {
        // Mostrar upload, ocultar textarea
        textareaContainer.style.display = 'none';
        uploadContainer.querySelector('.border').style.display = 'block';
        uploadContainer.querySelector('.mt-3 button').style.display = 'block';
    }
}

// Remover arquivo de resposta
function removerArquivoResposta(perguntaId) {
    if (confirm('Tem certeza que deseja remover este arquivo?')) {
        const statusElement = document.getElementById(`status-${perguntaId}`);
        statusElement.innerHTML = '<i class="fas fa-sync fa-spin text-primary"></i> Removendo...';
        
        fetch("{% url 'mimir:salvarResposta' prova_aluno.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                pergunta_id: perguntaId,
                resposta_texto: '' // Resposta vazia remove o arquivo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Recarregar a página para atualizar a interface
                location.reload();
            } else {
                throw new Error(data.message || 'Erro ao remover arquivo');
            }
        })
        .catch(error => {
            console.error('Erro ao remover arquivo:', error);
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erro ao remover';
        });
    }
}

// Upload de arquivo
function uploadArquivoResposta(perguntaId, arquivo) {
    const statusElement = document.getElementById(`status-${perguntaId}`);
    const badgeElement = document.getElementById(`status-badge-${perguntaId}`);
    
    statusElement.innerHTML = '<i class="fas fa-sync fa-spin text-primary"></i> Enviando arquivo...';
    
    const formData = new FormData();
    formData.append('pergunta_id', perguntaId);
    formData.append('arquivo_resposta', arquivo);
    
    fetch("{% url 'mimir:salvarResposta' prova_aluno.id %}", {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const agora = new Date(data.salvo_em);
            const hora = agora.getHours().toString().padStart(2, '0');
            const minuto = agora.getMinutes().toString().padStart(2, '0');
            
            statusElement.innerHTML = `<i class="fas fa-check text-success"></i> Arquivo salvo - ${hora}:${minuto}`;
            badgeElement.innerHTML = '<i class="fas fa-check text-success"></i> Respondida';
            badgeElement.className = 'badge bg-success';
            respostasSalvas.add(perguntaId);
            
            atualizarContadores();
            
            // Recarregar após um tempo para mostrar o arquivo
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'Erro ao enviar arquivo');
        }
    })
    .catch(error => {
        console.error('Erro ao enviar arquivo:', error);
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erro ao enviar';
        
        // Tentar novamente após 5 segundos
        setTimeout(() => {
            const inputArquivo = document.getElementById(`arquivo-${perguntaId}`);
            if (inputArquivo.files.length > 0) {
                uploadArquivoResposta(perguntaId, inputArquivo.files[0]);
            }
        }, 5000);
    });
}

// Preview do arquivo selecionado
function configurarPreviewArquivo(perguntaId) {
    const inputArquivo = document.getElementById(`arquivo-${perguntaId}`);
    const previewContainer = document.getElementById(`preview-arquivo-${perguntaId}`);
    const infoArquivo = document.getElementById(`info-arquivo-${perguntaId}`);
    
    inputArquivo.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            const file = this.files[0];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            // Validar tamanho
            if (file.size > 10 * 1024 * 1024) {
                alert('Arquivo muito grande. Tamanho máximo: 10MB');
                this.value = '';
                previewContainer.style.display = 'none';
                return;
            }
            
            // Validar tipo
            const tiposPermitidos = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/jpg',
                'image/png',
                'text/plain'
            ];
            
            if (!tiposPermitidos.includes(file.type)) {
                alert('Tipo de arquivo não permitido. Use PDF, Word, imagem ou texto.');
                this.value = '';
                previewContainer.style.display = 'none';
                return;
            }
            
            infoArquivo.innerHTML = `
                <i class="fas fa-file me-2"></i>
                <strong>Nome:</strong> ${file.name}<br>
                <strong>Tipo:</strong> ${file.type || 'Não identificado'}<br>
                <strong>Tamanho:</strong> ${fileSize} MB
            `;
            previewContainer.style.display = 'block';
            
            // Upload automático após seleção
            uploadArquivoResposta(perguntaId, file);
        } else {
            previewContainer.style.display = 'none';
        }
    });
}

// Salvar resposta via AJAX (texto)
function salvarResposta(perguntaId, respostaTexto = null) {
    // Se não foi passada a resposta, buscar do elemento apropriado
    if (respostaTexto === null) {
        const textarea = document.getElementById(`resposta-${perguntaId}`);
        const radioSelecionado = document.querySelector(`input[name="resposta-${perguntaId}"]:checked`);
        
        if (radioSelecionado) {
            // É uma pergunta de múltipla escolha
            respostaTexto = radioSelecionado.value;
        } else if (textarea) {
            // É uma pergunta de resposta aberta
            respostaTexto = textarea.value;
        } else {
            respostaTexto = '';
        }
    }
    
    const statusElement = document.getElementById(`status-${perguntaId}`);
    const badgeElement = document.getElementById(`status-badge-${perguntaId}`);
    
    // Se estiver vazio, não salva imediatamente (aguarda auto-save)
    if (!respostaTexto.trim()) {
        // Remove do conjunto de respostas salvas se estiver vazio
        if (respostasSalvas.has(perguntaId)) {
            respostasSalvas.delete(perguntaId);
            badgeElement.innerHTML = '<i class="fas fa-clock text-warning"></i> Pendente';
            badgeElement.className = 'badge bg-warning';
            statusElement.innerHTML = '<i class="fas fa-sync text-secondary"></i> Não salvo';
            atualizarContadores();
        }
        return;
    }
    
    // Atualizar visualmente imediatamente
    statusElement.innerHTML = '<i class="fas fa-sync fa-spin text-primary"></i> Salvando...';
    
    fetch("{% url 'mimir:salvarResposta' prova_aluno.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            pergunta_id: perguntaId,
            resposta_texto: respostaTexto
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const agora = new Date(data.salvo_em);
            const hora = agora.getHours().toString().padStart(2, '0');
            const minuto = agora.getMinutes().toString().padStart(2, '0');
            
            statusElement.innerHTML = `<i class="fas fa-check text-success"></i> Resposta salva - ${hora}:${minuto}`;
            
            badgeElement.innerHTML = '<i class="fas fa-check text-success"></i> Respondida';
            badgeElement.className = 'badge bg-success';
            respostasSalvas.add(perguntaId);
            
            atualizarContadores();
        } else {
            throw new Error(data.message || 'Erro ao salvar resposta');
        }
    })
    .catch(error => {
        console.error('Erro ao salvar resposta:', error);
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erro ao salvar';
        
        // Tentar novamente após 5 segundos se ainda houver resposta
        const radioSelecionado = document.querySelector(`input[name="resposta-${perguntaId}"]:checked`);
        const textarea = document.getElementById(`resposta-${perguntaId}`);
        if ((radioSelecionado && radioSelecionado.value.trim()) || (textarea && textarea.value.trim())) {
            setTimeout(() => salvarResposta(perguntaId), 5000);
        }
    });
}

// Função auxiliar para salvar resposta individual (usada no salvamento em lote)
function salvarRespostaIndividual(perguntaId) {
    let respostaTexto = '';
    
    // Verificar se é múltipla escolha ou resposta aberta
    const radioSelecionado = document.querySelector(`input[name="resposta-${perguntaId}"]:checked`);
    const textarea = document.getElementById(`resposta-${perguntaId}`);
    
    if (radioSelecionado) {
        respostaTexto = radioSelecionado.value;
    } else if (textarea) {
        respostaTexto = textarea.value.trim();
    }
    
    if (!respostaTexto) {
        return Promise.resolve({status: 'empty'});
    }
    
    return fetch("{% url 'mimir:salvarResposta' prova_aluno.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            pergunta_id: perguntaId,
            resposta_texto: respostaTexto
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            respostasSalvas.add(perguntaId);
            return data;
        } else {
            throw new Error(data.message || 'Erro ao salvar resposta');
        }
    });
}

// Salvar todas as respostas antes de finalizar
function salvarTodasRespostas() {
    const promises = [];
    const perguntaIds = new Set();
    
    // Coletar todas as perguntas
    {% for pergunta in perguntas %}
        perguntaIds.add({{ pergunta.id }});
    {% endfor %}
    
    // Para cada pergunta, tentar salvar
    perguntaIds.forEach(perguntaId => {
        promises.push(
            salvarRespostaIndividual(perguntaId)
                .catch(error => {
                    console.error(`Erro ao salvar questão ${perguntaId}:`, error);
                    // Continua mesmo com erro, mas marca como não salvo
                    return {status: 'error', perguntaId: perguntaId};
                })
        );
    });
    
    return Promise.allSettled(promises);
}

function atualizarContadores() {
    const total = {{ perguntas|length }};
    const respondidas = respostasSalvas.size;
    const pendentes = total - respondidas;
    
    // Atualizar todos os contadores
    const contadorRespostasHeader = document.getElementById('contador-respostas-header');
    const contadorPendentesHeader = document.getElementById('contador-pendentes-header');
    const contadorRespostasFinal = document.getElementById('contador-respostas-final');
    const contadorRespostasModal = document.getElementById('contador-respostas-modal');
    const contadorPendentesModal = document.getElementById('contador-pendentes-modal');
    
    if (contadorRespostasHeader) contadorRespostasHeader.textContent = respondidas;
    if (contadorPendentesHeader) contadorPendentesHeader.textContent = pendentes;
    if (contadorRespostasFinal) contadorRespostasFinal.textContent = respondidas;
    if (contadorRespostasModal) contadorRespostasModal.textContent = respondidas;
    if (contadorPendentesModal) contadorPendentesModal.textContent = pendentes;
    
    // Atualizar cores dos contadores
    if (contadorPendentesHeader) {
        contadorPendentesHeader.className = pendentes > 0 ? 'text-warning' : 'text-success';
    }
    if (contadorPendentesModal) {
        contadorPendentesModal.className = pendentes > 0 ? 'text-warning' : 'text-success';
    }
}

// ===== INICIALIZAÇÃO E EVENT LISTENERS =====

function inicializarProva() {
    // Inicializar contador de respostas salvas
    {% for pergunta in perguntas %}
        {% with resposta_existente=respostas_existentes|get_item:pergunta.id %}
        {% if resposta_existente and resposta_existente.resposta_texto.strip %}
        respostasSalvas.add({{ pergunta.id }});
        {% endif %}
        {% if resposta_existente and resposta_existente.arquivo_resposta %}
        respostasSalvas.add({{ pergunta.id }});
        {% endif %}
        {% endwith %}
    {% endfor %}

    // Se a prova já foi iniciada, calcular tempo restante baseado no início
    {% if prova_aluno.data_inicio %}
        const tempoDecorrido = Math.floor((new Date().getTime() - new Date('{{ prova_aluno.data_inicio|date:"c" }}').getTime()) / 1000);
        tempoRestante = Math.max(0, {{ aplicacao.tempo_limite.total_seconds|default:7200|stringformat:"d" }} - tempoDecorrido);
    {% endif %}

    // Configurar upload de arquivo para perguntas que aceitam
    {% for pergunta in perguntas %}
        {% if pergunta.aceita_upload_resposta %}
        configurarPreviewArquivo({{ pergunta.id }});
        {% endif %}
    {% endfor %}

    atualizarContadores();
    iniciarTimer();

    // Configurar modal de finalização
    const finalizarModal = document.getElementById('finalizarModal');
    
    if (finalizarModal) {
        finalizarModal.addEventListener('show.bs.modal', function() {
            atualizarContadores();
            
            // Listar questões pendentes
            const listaPendentes = document.getElementById('lista-pendentes');
            const alertPendentes = document.getElementById('alert-pendentes');
            const total = {{ perguntas|length }};
            const pendentes = total - respostasSalvas.size;
            
            if (pendentes > 0 && listaPendentes && alertPendentes) {
                let listaHTML = '';
                // Percorre todas as perguntas para encontrar as pendentes
                {% for pergunta in perguntas %}
                    if (!respostasSalvas.has({{ pergunta.id }})) {
                        listaHTML += `<span class="badge bg-warning me-1 mb-1">Questão {{ forloop.counter }}</span>`;
                    }
                {% endfor %}
                listaPendentes.innerHTML = listaHTML;
                alertPendentes.style.display = 'block';
            } else if (alertPendentes) {
                alertPendentes.style.display = 'none';
            }
        });
        
        // Botão de finalização confirmado
        const btnFinalizar = document.getElementById('btn-finalizar-confirmado');
        if (btnFinalizar) {
            btnFinalizar.addEventListener('click', function() {
                // Desabilitar botão para evitar múltiplos cliques
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Finalizando...';
                
                salvarTodasRespostas().then(() => {
                    window.location.href = "{% url 'mimir:finalizarProva' prova_aluno.id %}";
                });
            });
        }
    }
    
    // Adicionar rolagem suave para as questões
    document.querySelectorAll('.questao-item .card-header').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            this.parentElement.scrollIntoView({ behavior: 'smooth' });
        });
    });

    // Adicionar event listeners para os textareas
    document.querySelectorAll('.resposta-texto').forEach(textarea => {
        textarea.addEventListener('keyup', function() {
            const perguntaId = this.dataset.perguntaId;
            // Debounce para evitar muitas requisições
            clearTimeout(this._timeout);
            this._timeout = setTimeout(() => {
                salvarResposta(perguntaId);
            }, 1000); // Espera 1 segundo após a última tecla
        });
    });

    // Adicionar event listeners para os radio buttons
    document.querySelectorAll('.alternativa-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            const perguntaId = this.dataset.perguntaId;
            // Salvar imediatamente quando selecionar uma alternativa
            salvarResposta(perguntaId);
        });
    });

    // Auto-save periódico
    setInterval(() => {
        // Para questões de múltipla escolha, não precisa salvar periodicamente pois já salvam automaticamente
        // Apenas para questões de resposta aberta
        document.querySelectorAll('.resposta-texto').forEach(textarea => {
            if (textarea.value.trim()) {
                const perguntaId = textarea.dataset.perguntaId;
                salvarResposta(perguntaId);
            }
        });
    }, 30000); // Salva a cada 30 segundos

    // Prevenir saída acidental da página
    window.addEventListener('beforeunload', function(e) {
        if (respostasSalvas.size > 0) {
            e.preventDefault();
            e.returnValue = 'Você tem respostas não salvas. Tem certeza que deseja sair?';
            return e.returnValue;
        }
    });
}

// ===== INICIAR A APLICAÇÃO QUANDO O DOCUMENTO ESTIVER PRONTO =====
document.addEventListener('DOMContentLoaded', function() {
    inicializarProva();
});
</script>

<style>
.alternativas-container {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
}

.upload-resposta-container {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-check-label {
    cursor: pointer;
    margin-left: 0.5rem;
}

.arquivo-resposta:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Estilo para o preview de arquivo */
.preview-arquivo {
    transition: all 0.3s ease;
}

.sticky-bottom {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 1000;
}
</style>
{% endblock %}